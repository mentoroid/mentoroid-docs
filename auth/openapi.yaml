openapi: 3.0.3
info:
  title: Mentoroid Steam Authentication API
  description: |
    Steam OpenID authentication endpoints for the Mentoroid platform.

    ## Overview

    These endpoints handle user authentication via Steam OpenID. After successful authentication,
    users receive an API key that can be used to access other Mentoroid APIs.

    **No API key is required** to use these endpoints - they are used to obtain one.

    ## Authentication Flow

    ```
    ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
    │  Mentoroid App  │     │   Mentoroid     │     │     Steam       │
    │    (Client)     │     │    Backend      │     │                 │
    └────────┬────────┘     └────────┬────────┘     └────────┬────────┘
             │                       │                       │
             │  1. GET /auth/steam/login                     │
             │ ─────────────────────>│                       │
             │                       │                       │
             │  2. 302 Redirect      │                       │
             │ <─────────────────────│                       │
             │                       │                       │
             │  3. User logs in      │                       │
             │ ──────────────────────────────────────────────>│
             │                       │                       │
             │  4. Steam redirects to /auth/callback         │
             │ <──────────────────────────────────────────────│
             │                       │                       │
             │  5. Backend verifies  │                       │
             │ ─────────────────────>│                       │
             │                       │                       │
             │  6. Deep link with API key                    │
             │ <─────────────────────│                       │
             │                       │                       │
             │  mentoroid://auth/callback?steam_id=XXX&token=mk_YYY
             │                       │                       │
    ```

    ## Deep Link Format

    **Success:**
    ```
    mentoroid://auth/callback?steam_id=76561199813585151&token=mk_abc123...
    ```

    **Error:**
    ```
    mentoroid://auth/callback?error=verification_failed&message=Steam+login+verification+failed.+Please+try+again.&request_id=a1b2c3d4
    ```

    ## Rate Limits

    | Endpoint | Limit |
    |----------|-------|
    | `/auth/steam/login` | 10 requests/minute per IP |
    | `/auth/callback` | 20 requests/minute per IP |

  version: 1.0.0
  contact:
    name: Mentoroid Team
    email: dev@mentoroid.ai
  license:
    name: Proprietary

servers:
  - url: https://dev.mentoroid.ai
    description: Development
  - url: https://api.mentoroid.ai
    description: Production

tags:
  - name: Steam Authentication
    description: Steam OpenID authentication endpoints

paths:
  /auth/steam/login:
    get:
      tags:
        - Steam Authentication
      summary: Initiate Steam login
      description: |
        Initiates Steam OpenID authentication flow.

        **This endpoint does NOT require an API key** - it's used to obtain one.

        ## Flow
        1. Flutter app opens this URL in browser/webview
        2. User is redirected to Steam's login page
        3. After login, Steam redirects to `/auth/callback`
        4. User receives API key via deep link

        ## Usage
        ```
        GET https://dev.mentoroid.ai/auth/steam/login
        ```

        The response is a 302 redirect to Steam's OpenID login page.

        ## Rate Limits
        - 10 requests per minute per IP
      operationId: steamLogin
      responses:
        '302':
          description: Redirect to Steam login page
          headers:
            Location:
              description: Steam OpenID login URL
              schema:
                type: string
                example: "https://steamcommunity.com/openid/login?openid.ns=..."
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/callback:
    get:
      tags:
        - Steam Authentication
      summary: Steam login callback
      description: |
        Handles the callback from Steam after successful OpenID authentication.

        **This endpoint does NOT require an API key** - it generates one.

        ## Flow
        1. Steam redirects here after successful login
        2. Server verifies the OpenID response with Steam
        3. Server creates user in Firebase (if new) or retrieves existing user
        4. Server redirects to Flutter app via deep link with credentials

        ## Deep Link Format

        **Success:**
        ```
        mentoroid://auth/callback?steam_id=76561199813585151&token=mk_abc123...
        ```

        **Error:**
        ```
        mentoroid://auth/callback?error=<error_code>&message=<url_encoded_message>&request_id=<short_uuid>
        ```

        Example:
        ```
        mentoroid://auth/callback?error=verification_failed&message=Steam+login+verification+failed.+Please+try+again.&request_id=a1b2c3d4
        ```

        ## Error Types
        | Error | Message | Description |
        |-------|---------|-------------|
        | `verification_failed` | Steam login verification failed. Please try again. | Steam OpenID verification failed |
        | `invalid_steam_id` | Invalid Steam account. Please use a valid Steam account. | Could not extract Steam ID from response |
        | `user_creation_failed` | Failed to create your account. Please try again later. | Failed to create/retrieve user in Firebase |
        | `server_error` | An unexpected error occurred. Please try again later. | Unexpected server error |

        ## Rate Limits
        - 20 requests per minute per IP
      operationId: steamCallback
      parameters:
        - name: openid.ns
          in: query
          description: OpenID namespace (set by Steam)
          schema:
            type: string
            example: "http://specs.openid.net/auth/2.0"
        - name: openid.mode
          in: query
          description: OpenID mode (should be "id_res" for positive assertion)
          schema:
            type: string
            example: "id_res"
        - name: openid.op_endpoint
          in: query
          description: OpenID provider endpoint URL
          schema:
            type: string
            example: "https://steamcommunity.com/openid/login"
        - name: openid.claimed_id
          in: query
          description: Contains the Steam ID URL
          schema:
            type: string
            example: "https://steamcommunity.com/openid/id/76561199813585151"
        - name: openid.identity
          in: query
          description: Steam identity URL (same as claimed_id)
          schema:
            type: string
            example: "https://steamcommunity.com/openid/id/76561199813585151"
        - name: openid.signed
          in: query
          description: Comma-separated list of signed fields
          schema:
            type: string
        - name: openid.sig
          in: query
          description: Base64-encoded HMAC-SHA1 signature for verification
          schema:
            type: string
      responses:
        '302':
          description: Redirect to Flutter app via deep link
          headers:
            Location:
              description: Deep link URL with steam_id and token (or error)
              schema:
                type: string
                example: "mentoroid://auth/callback?steam_id=76561199813585151&token=mk_abc123..."
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'

components:
  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          description: Error type
        message:
          type: string
          description: Human-readable error message

    RateLimitError:
      type: object
      properties:
        error:
          type: string
          example: "Rate limit exceeded"
        message:
          type: string
          example: "Rate limit exceeded. Please try again later."
        retry_after:
          type: integer
          description: Seconds until rate limit resets
          example: 60
